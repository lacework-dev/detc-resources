---
testeks:
  steps:
    - name: eks
      extension: EKS
      args:
        region: us-east-2
        deployment_name: testeks

    - name: deploy-vote-app
      extension: Kubectl
      tags: app
      source: https://raw.githubusercontent.com/lacework-dev/detc-resources/main/apps/voteapp.yml
      needs:
        - eks
      helpers:
        - helper: WriteValue
          run_on_dryrun: true
          args:
            raw_value: !lookupSecret /eks/outputs/kubectl_config
            dstfile: kubectl
      args:
        control_plane_url: !lookup /eks/outputs/cluster_endpoint
        kubectl_config_file: kubectl
        kube_manifest_path: vote.yml
        wait_for:
           vote_app_url:
              app_name: "vote"
              field: "load_balancer_ip"
           result_app_url:
              app_name: "result"
              field: "load_balancer_ip"
