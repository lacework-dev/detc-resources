---
testeks:
  steps:
    - name: eks
      extension: EKS
      args:
        region: us-east-2
        deployment_name: testeks

    - name: deploy-vote-app
      extension: Kubectl
      tags: app
      source: https://raw.githubusercontent.com/lacework-dev/detc-resources/main/apps/voteapp.yml
      needs:
        - eks
      lookup:
        kubectl_config: 
          key: /eks/outputs/kubectl_config
          secret: true
        control_plane_url: /eks/outputs/cluster_endpoint
      helpers:
        - helper: WriteValue
          run_on_dryrun: true
          args:
            name: kubectl_config
            dstfile: kubectl
      args:
        kubectl_config_file: kubectl
        kube_manifest_path: voteapp.yml
        wait_for:
           vote_app_url:
              app_name: "vote"
              field: "load_balancer_ip"
           result_app_url:
              app_name: "result"
              field: "load_balancer_ip"
